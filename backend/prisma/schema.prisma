// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTH & SESSIONS ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  isPlatformAdmin Boolean @default(false)
  createdAt     DateTime  @default(now())

  sessions      Session[]
  memberships   Member[]
  auditEvents   AuditEvent[]
  completedChecklistItems DealChecklistItem[]

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ==================== WORKSPACE & MEMBERS ====================

model Workspace {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  members   Member[]
  clients   Client[]
  deals     Deal[]
  tasks     Task[]
  invites   Invite[]
  chatRooms ChatRoom[]
  templates Template[]
  campaigns Campaign[]
  integrations Integration[]
  invoices  Invoice[]
  auditEvents AuditEvent[]
  taskTemplates TaskTemplate[]

  @@map("workspaces")
}

model Member {
  id          String    @id @default(uuid())
  workspaceId String
  userId      String
  role        String    // OWNER, ADMIN, MANAGER, AGENT, VIEWER
  createdAt   DateTime  @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("members")
}

model Invite {
  id          String    @id @default(uuid())
  workspaceId String
  email       String
  role        String
  token       String    @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("invites")
}

// ==================== BUSINESS ENTITIES ====================

model Client {
  id              String   @id @default(uuid())
  workspaceId     String
  assignedToUserId String?
  name            String
  email           String?
  phone           String?
  notes           String?
  tags            String?  // JSON array или comma-separated
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  deals           Deal[]
  tasks           Task[]

  @@map("clients")
}

model Deal {
  id              String   @id @default(uuid())
  workspaceId     String
  clientId        String?
  stage           String   // pipeline stage
  amount          Decimal? @db.Decimal(10, 2)
  assignedToUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  tasks           Task[]
  checklistItems  DealChecklistItem[]

  @@map("deals")
}

// Чек-листы для этапов сделок
// Выбран вариант с отдельной таблицей вместо JSON-поля для:
// 1. Отслеживания кто и когда отметил пункт (completedByUserId, completedAt)
// 2. Возможности аналитики по выполнению чек-листов
// 3. Нормализации данных и лучшей производительности запросов
model DealChecklistItem {
  id              String   @id @default(uuid())
  dealId          String
  stage           String   // этап сделки, для которого этот пункт
  title           String   // название пункта чек-листа
  completed       Boolean  @default(false)
  completedByUserId String?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  deal            Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  completedBy     User?    @relation(fields: [completedByUserId], references: [id], onDelete: SetNull)

  @@unique([dealId, stage, title])
  @@map("deal_checklist_items")
}

model Task {
  id              String   @id @default(uuid())
  workspaceId     String
  title           String
  description     String?
  dueAt           DateTime?
  status          String   // TODO, IN_PROGRESS, DONE, CANCELLED
  assignedToUserId String?
  relatedClientId String?
  relatedDealId   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client          Client?   @relation(fields: [relatedClientId], references: [id], onDelete: SetNull)
  deal            Deal?     @relation(fields: [relatedDealId], references: [id], onDelete: SetNull)

  @@map("tasks")
}

// Шаблоны задач для автоматического создания при событиях
model TaskTemplate {
  id          String   @id @default(uuid())
  workspaceId String
  triggerType String   // DEAL_CREATED, DEAL_STAGE_CHANGED
  triggerValue String? // для DEAL_STAGE_CHANGED - название стадии
  title       String
  description String?
  dueDays     Int?     // через сколько дней должна быть выполнена (null = без срока)
  status      String   @default("TODO") // статус создаваемой задачи
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("task_templates")
}

// ==================== CHAT ====================

model ChatRoom {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  type        String   // DIRECT, GROUP, CHANNEL
  createdAt   DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@map("chat_rooms")
}

model ChatMessage {
  id        String   @id @default(uuid())
  roomId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// ==================== CAMPAIGNS & TEMPLATES ====================

model Template {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  subject     String?
  body        String
  type        String   // EMAIL, SMS, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  campaigns   Campaign[]

  @@map("templates")
}

model Campaign {
  id          String   @id @default(uuid())
  workspaceId String
  templateId  String?
  name        String
  status      String   // DRAFT, SCHEDULED, RUNNING, COMPLETED, CANCELLED
  scheduledAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  template    Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  messageLogs MessageLog[]

  @@map("campaigns")
}

model MessageLog {
  id          String   @id @default(uuid())
  campaignId  String?
  recipient   String   // email/phone
  status      String   // SENT, FAILED, BOUNCED
  sentAt      DateTime @default(now())
  error       String?

  campaign    Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@map("message_logs")
}

// ==================== INTEGRATIONS ====================

model Integration {
  id          String   @id @default(uuid())
  workspaceId String
  type        String   // EMAIL, TELEGRAM, VK, WHATSAPP
  status      String   // ACTIVE, INACTIVE, ERROR
  dataJson    String?  // JSON с токенами/настройками
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("integrations")
}

// ==================== PAYMENTS ====================

model Invoice {
  id          String   @id @default(uuid())
  workspaceId String
  number      String   @unique
  amount      Decimal  @db.Decimal(10, 2)
  status      String   // DRAFT, SENT, PAID, CANCELLED
  dueAt       DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  payments    Payment[]

  @@map("invoices")
}

model Payment {
  id          String   @id @default(uuid())
  invoiceId   String
  amount      Decimal  @db.Decimal(10, 2)
  method      String   // CARD, BANK_TRANSFER, etc.
  status      String   // PENDING, COMPLETED, FAILED
  externalId  String?  // ID из платежной системы
  metadataJson String? // JSON с данными webhook
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ==================== AUDIT ====================

model AuditEvent {
  id          String   @id @default(uuid())
  workspaceId String?
  actorUserId String
  entityType  String   // Client, Deal, Task, etc.
  entityId    String?
  action      String   // CREATE, UPDATE, DELETE
  payloadJson String?  // JSON с diff или данными
  createdAt   DateTime @default(now())

  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  actor       User       @relation(fields: [actorUserId], references: [id], onDelete: Cascade)

  @@map("audit_events")
}


